<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Machine Booking System</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    button { margin: 5px; padding: 8px 12px; }
    ul, table { width: 100%; margin-top: 10px; }
    ul { list-style: none; padding: 0; }
    li { margin: 4px 0; cursor: pointer; }
    table { border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    input, select, label { display: block; margin: 4px 0; }
    #weekly-view { margin-top:20px; }
    #weekly-view table { width:auto; }
  </style>
</head>
<body>
  <h1>Machine Booking System</h1>

  <div id="mode-selection">
    <button id="admin-btn">Admin</button>
    <button id="user-btn">User</button>
  </div>

  <div id="login-prompt" class="hidden">
    <h3>Admin Login</h3>
    <input type="password" id="pw-input" placeholder="Password" />
    <button id="pw-submit">Login</button>
    <button id="pw-cancel">Cancel</button>
    <div id="pw-error" style="color:red;"></div>
  </div>

  <!-- Admin -->
  <section id="admin-section" class="hidden">
    <h2>Admin Panel</h2>
    <button id="admin-back">Back</button>
    <h3>Manage Machines</h3>
    <input type="text" id="machine-name-input" placeholder="Machine name" />
    <button id="add-machine-btn">Add Machine</button>
    <ul id="machines-list"></ul>
    <button id="view-logs-btn">View Logs</button>
    <button id="view-audit-btn">View Audit</button>
    <button id="view-weekly-btn">Toggle Weekly View</button>
    <div id="weekly-view" class="hidden">
      <h3>Weekly Schedule (9am-5pm)</h3>
      <table>
        <thead>
          <tr><th>Hour</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr>
        </thead>
        <tbody id="weekly-body"></tbody>
      </table>
    </div>
  </section>

  <!-- User -->
  <section id="user-section" class="hidden">
    <h2>User Booking</h2>
    <button id="user-back">Back</button>
    <h3>Select Machine</h3>
    <ul id="user-machines"></ul>
    <div id="booking-form" class="hidden">
      <h3>Book: <span id="booking-machine-name"></span></h3>
      <label>Name: <input type="text" id="booking-name" /></label>
      <label>Email: <input type="email" id="booking-email" /></label>
      <label>Start: <input type="datetime-local" id="booking-start" /></label>
      <label>End: <input type="datetime-local" id="booking-end" /></label>
      <button id="submit-booking-btn">Submit</button>
      <div id="booking-error" style="color:red;"></div>
    </div>
    <h3>Your Active Bookings</h3>
    <ul id="booking-list"></ul>
  </section>

  <!-- Logs -->
  <section id="log-section" class="hidden">
    <h2>Usage Logs</h2>
    <button id="log-back-btn">Back</button>
    <table>
      <thead>
        <tr><th>Machine</th><th>User</th><th>Start</th><th>End</th><th>Physical</th><th>Physical Time</th><th>Recipe</th><th>Recipe Time</th><th>Pressure</th><th>Pressure Time</th><th>Completed</th><th>Completed Time</th></tr>
      </thead>
      <tbody id="log-table-body"></tbody>
    </table>
  </section>

  <!-- Audit -->
  <section id="audit-section" class="hidden">
    <h2>Audit Log</h2>
    <button id="audit-back-btn">Back</button>
    <table>
      <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
      <tbody id="audit-table-body"></tbody>
    </table>
  </section>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // Replace with your actual Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBuJv6jHOOnzvnHHoX9t_b3mTYeMK10tCM",
      authDomain: "machine-booking-3c611.firebaseapp.com",
      projectId: "machine-booking-3c611",
      storageBucket: "machine-booking-3c611.appspot.com",
      messagingSenderId: "417259615223",
      appId: "1:417259615223:web:8535395de07d7bce0db4f2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.addEventListener('DOMContentLoaded', () => {
      const ADMIN_PASS = '0404';
      const modeSel = document.getElementById('mode-selection');
      const sections = {
        login: document.getElementById('login-prompt'),
        admin: document.getElementById('admin-section'),
        user: document.getElementById('user-section'),
        log: document.getElementById('log-section'),
        audit: document.getElementById('audit-section')
      };
      const pwInput = document.getElementById('pw-input');
      const pwError = document.getElementById('pw-error');
      let subs = {};

      function hideAll() {
        Object.values(sections).forEach(s => s.classList.add('hidden'));
        Object.values(subs).forEach(un => un && un());
        subs = {};
      }

      function show(sec) {
        sec.classList.remove('hidden');
      }

      hideAll();
      show(modeSel);

      // Admin flow
      document.getElementById('admin-btn').onclick = () => {
        hideAll(); pwInput.value = ''; pwError.textContent = '';
        show(sections.login);
      };

      document.getElementById('pw-cancel').onclick = () => {
        hideAll(); show(modeSel);
      };

      document.getElementById('pw-submit').onclick = () => {
        if (pwInput.value !== ADMIN_PASS) {
          pwError.textContent = 'Incorrect password';
          return;
        }
        hideAll(); show(sections.admin);

        // Real-time machines list
        subs.mach = onSnapshot(collection(db, 'machines'), snap => {
          const ul = document.getElementById('machines-list');
          ul.innerHTML = '';
          snap.forEach(d => {
            const li = document.createElement('li');
            li.textContent = d.data().name;
            ul.appendChild(li);
          });
        });

        // Real-time usage logs
        subs.logA = onSnapshot(query(collection(db, 'bookings'), orderBy('start', 'asc')), snap => renderLog(snap));
      };

      document.getElementById('admin-back').onclick = () => {
        hideAll(); show(modeSel);
      };

      document.getElementById('add-machine-btn').onclick = () => {
        const name = document.getElementById('machine-name-input').value.trim();
        if (!name) return;
        addDoc(collection(db, 'machines'), { name });
        addDoc(collection(db, 'audit'), { time: Date.now(), user: 'Admin', action: 'Add Machine', details: name });
      };

      document.getElementById('view-logs-btn').onclick = () => {
        hideAll(); show(sections.log);
      };

      document.getElementById('view-audit-btn').onclick = () => {
        hideAll(); show(sections.audit);
        subs.audit = onSnapshot(query(collection(db, 'audit'), orderBy('time', 'asc')), snap => renderAudit(snap));
      };

      document.getElementById('view-weekly-btn').onclick = () => {
        document.getElementById('weekly-view').classList.toggle('hidden');
        renderWeekly();
      };

      document.getElementById('log-back-btn').onclick = () => {
        hideAll(); show(sections.admin);
      };

      document.getElementById('audit-back-btn').onclick = () => {
        hideAll(); show(sections.admin);
      };

      // User flow
      document.getElementById('user-btn').onclick = () => {
        hideAll(); show(sections.user);

        // Real-time machines for user
        subs.machU = onSnapshot(collection(db, 'machines'), snap => {
          const ul = document.getElementById('user-machines');
          ul.innerHTML = '';
          snap.forEach(d => {
            const li = document.createElement('li');
            li.textContent = d.data().name;
            li.onclick = () => {
              document.getElementById('booking-machine-name').textContent = d.data().name;
              document.getElementById('booking-form').classList.remove('hidden');
            };
            ul.appendChild(li);
          });
        });

        // Real-time active bookings
        subs.bookU = onSnapshot(query(collection(db, 'bookings'), orderBy('start', 'asc')), snap => {
          const ul = document.getElementById('booking-list');
          ul.innerHTML = '';
          snap.forEach(d => {
            const b = d.data();
            if (b.completed) return;
            const li = document.createElement('li');
            li.textContent = `${b.machine}: ${b.user} (${b.start}→${b.end})`;
            li.onclick = () => openBookingDetail(d.id, b);
            ul.appendChild(li);
          });
        });
      };

      document.getElementById('user-back').onclick = () => {
        hideAll(); show(modeSel);
      };

      document.getElementById('submit-booking-btn').onclick = async () => {
        console.log('SUBMIT CLICKED');
        const m = document.getElementById('booking-machine-name').textContent;
        const u = document.getElementById('booking-name').value.trim();
        const e = document.getElementById('booking-email').value.trim();
        const s = document.getElementById('booking-start').value;
        const en = document.getElementById('booking-end').value;
        if (!u || !e || !s || !en || en <= s) {
          alert('Fill all fields and ensure end after start');
          return;
        }
        // Double-book prevention
        const snap = await getDocs(query(collection(db, 'bookings'), orderBy('start', 'asc')));
        for (const docItem of snap.docs) {
          const b = docItem.data();
          if (b.machine === m && !(en <= b.start || s >= b.end)) {
            alert('Time slot already booked');
            return;
          }
        }
        await addDoc(collection(db, 'bookings'), { machine: m, user: u, email: e, start: s, end: en, completed: false });
        await addDoc(collection(db, 'audit'), { time: Date.now(), user: u, action: 'Create Booking', details: m });
        document.getElementById('booking-form').classList.add('hidden');
      };

      // Render helpers
      function renderLog(snap) {
        const tbody = document.getElementById('log-table-body');
        tbody.innerHTML = '';
        snap.forEach(d => {
          const b = d.data();
          const row = document.createElement('tr');
          [
            b.machine, b.user, b.start, b.end,
            b.physical ? '✔' : '✘', b.physicalTime ? new Date(b.physicalTime).toLocaleString('en-AU') : '',
            b.recipe ? '✔' : '✘', b.recipeTime ? new Date(b.recipeTime).toLocaleString('en-AU') : '',
            b.pressure || '', b.pressureTime ? new Date(b.pressureTime).toLocaleString('en-AU') : '',
            b.completed ? '✔' : '✘', b.completedTime ? new Date(b.completedTime).toLocaleString('en-AU') : ''
          ].forEach(v => { const td = document.createElement('td'); td.textContent = v; row.appendChild(td); });
          tbody.appendChild(row);
        });
      }

      function renderAudit(snap) {
        const tbody = document.getElementById('audit-table-body');
        tbody.innerHTML = '';
        snap.forEach(d => {
          const a = d.data();
          const row = document.createElement('tr');
          [
            new Date(a.time).toLocaleString('en-AU'), a.user, a.action, a.details
          ].forEach(v => { const td = document.createElement('td'); td.textContent = v; row.appendChild(td); });
          tbody.appendChild(row);
        });
      }

      async function renderWeekly() {
        const slots = {};
        const snap = await getDocs(query(collection(db, 'bookings'), orderBy('start', 'asc')));
        snap.docs.forEach(d => {
          const b = d.data();
          const day = new Date(b.start).getDay();
          const hour = new Date(b.start).getHours();
          if (hour >= 9 && hour < 17) slots[day + '-' + hour] = true;
        });
        const tbody = document.getElementById('weekly-body');
        tbody.innerHTML = '';
        for (let h = 9; h < 17; h++) {
          const row = document.createElement('tr');
          const th = document.createElement('th');
          th.textContent = h + ':00';
          row.appendChild(th);
          for (let d = 1; d <= 7; d++) {
            const td = document.createElement('td');
            td.textContent = slots[d + '-' + h] ? 'X' : '';
            row.appendChild(td);
          }
          tbody.appendChild(row);
        }
      }

      async function openBookingDetail(id, b) {
        const detail = document.getElementById('booking-detail') || document.createElement('div');
        detail.id = 'booking-detail';
        detail.innerHTML = `
          <h3>Booking Details</h3>
          <p><strong>Machine:</strong> ${b.machine}</p>
          <p><strong>User:</strong> ${b.user} (${b.email})</p>
          <p><strong>Start:</strong> ${b.start}</p>
          <p><strong>End:</strong> ${b.end}</p>
          <label><input type="checkbox" id="chk-phys" ${b.physical ? 'checked' : ''}/> Physical Cleaning</label>
          <label><input type="checkbox" id="chk-rec" ${b.recipe ? 'checked' : ''}/> Recipe Cleaning</label>
          <label>Pressure: <input type="number" id="inp-pr" value="${b.pressure || ''}"/></label>
          <label>Recipe Used: 
            <select id="sel-rec">
              <option value="1" ${b.pressureRecipe === '1' ? 'selected' : ''}>1</option>
              <option value="2" ${b.pressureRecipe === '2' ? 'selected' : ''}>2</option>
              <option value="3" ${b.pressureRecipe === '3' ? 'selected' : ''}>3</option>
              <option value="4" ${b.pressureRecipe === '4' ? 'selected' : ''}>4</option>
            </select>
          </label>
          <button id="btn-save">Save</button>
          <button id="btn-complete">Complete</button>
          <button id="btn-cancel">Cancel</button>
        `;
        document.getElementById('user-section').appendChild(detail);
        detail.querySelector('#btn-cancel').onclick = () => detail.remove();
        detail.querySelector('#btn-save').onclick = async () => {
          const phys = detail.querySelector('#chk-phys').checked;
          const rec = detail.querySelector('#chk-rec').checked;
          const pres = detail.querySelector('#inp-pr').value;
          const presRec = detail.querySelector('#sel-rec').value;
          await updateDoc(doc(db, 'bookings', id), {
            physical: phys,
            recipe: rec,
            pressure: pres,
            pressureRecipe: presRec,
            physicalTime: phys ? Date.now() : null,
            recipeTime: rec ? Date.now() : null,
            pressureTime: pres ? Date.now() : null
          });
          detail.remove();
        };
        detail.querySelector('#btn-complete').onclick = async () => {
          await updateDoc(doc(db, 'bookings', id), { completed: true, completedTime: Date.now() });
          await addDoc(collection(db, 'audit'), { time: Date.now(), user: b.user, action: 'Complete Booking', details: b.machine });
          detail.remove();
        };
      }

    });
  </script>
</body>
</html>

